name: Pedagogical Tests

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-18]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install compiler
        run: |
          sudo apt-get update
          if [[ "${{ matrix.compiler }}" == gcc-* ]]; then
            version="${{ matrix.compiler }}"
            version="${version#gcc-}"
            sudo apt-get install -y "g++-${version}"
            echo "CXX=g++-${version}" >> "$GITHUB_ENV"
          else
            version="${{ matrix.compiler }}"
            version="${version#clang-}"
            sudo apt-get install -y "clang-${version}"
            echo "CXX=clang++-${version}" >> "$GITHUB_ENV"
          fi

      - name: Compile pedagogical tests
        run: |
          mkdir -p build/tests
          for file in tests/pedagogie/*.cpp; do
            base=$(basename "$file" .cpp)
            echo "Compiling $file with $CXX"
            $CXX -std=c++20 -Wall -Wextra -Wpedantic -Werror -O2 "$file" -o "build/tests/$base"
          done

      - name: Run pedagogical tests
        run: |
          for bin in build/tests/*; do
            echo "Running $bin"
            "$bin"
          done
